<!DOCTYPE html>
<html>
<head>
    <title>ELSEWeb GUI</title>
    <meta charset="utf-8">
    <link href="../../content/shared/styles/examples-offline.css" rel="stylesheet">
    <link href="../../../styles/kendo.common.min.css" rel="stylesheet">
    <link href="../../../styles/kendo.rtl.min.css" rel="stylesheet">
    <link href="../../../styles/kendo.flat.min.css" rel="stylesheet">

    <script src="../../../js/jquery.min.js"></script>
    <script src="../../../js/kendo.web.min.js"></script>
    <script src="../../content/shared/js/console.js"></script>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCotZjhwqwQ-4UjBvZHJNrQK0Yew5M2sOQ&sensor=true"></script>  
	

    
    
</head>
<body>
    <div id="main-window" class="k-content"> 
		<div id="window">
		 <div id="horizontal" style="height: 100%; width: 100%;">
				
				<div id="left-pane">
				
				<!-- Region Section -->
				<fieldset>
				<legend>Region</legend>
				<div class="k-grouping-header" data-role="droptarget" style="width: 640px">Enter coordinates or drag point in map to set bounding box for the experiment</div>
				<label><input type="textbox" id="boundsText"  class="k-textbox" style= "width: 645px; font-size: 11.5px; color: grey;" placeholder= "e.g. 50, -65.123, 23, -126 (N, E, S, W) (Press the 'TAB' key)" title="N, E, S, W" onchange="changeBounds()" onkeypress="return noEnter()"/> </label> 

				<br>
				<div id="map-canvas" class="map" style="width:645px"></div>
				
				<br>
				</fieldset>
							
				<!-- Species Section -->
				<fieldset>
				<legend>Species</legend>
				<div class="k-grouping-header" data-role="droptarget" style="width: 640px">Select species OR upload your own species file</div>
					<form method="post" action="submit" style="width:98%">
						<input id="species" style="width: 300px"/> or <input name="files" id="files" type="file" /> 
					<br><br>					
					</form>
					<br>
				</fieldset>
				</div>				
				
				<div id="center-pane">
				
				<!-- Data Form -->		
				<fieldset>
				<legend>Data</legend>
				<div class="k-grouping-header" data-role="droptarget" style="width: 598px">Select up to 10 data sets </div>
				<!-- data-table -->
				<div id="grid" style= "height:530px; width: 601px;"></div>
				<!-- end data-table -->
				</fieldset>
			
				<!-- Algorithm Section -->
				<fieldset>
				<legend>Algorithm</legend>
				
				<div class="k-grouping-header" data-role="droptarget" style="width: 598px">Select algorithm and modify parameters' values (default value shown)</div>
				<div id="parameterGrid" style= "height:270px; width: 601px;"></div>
				</fieldset>
				</div>
				
				
				<div id="right-pane">
				<!-- Model Section -->
				<fieldset>
				<legend>Model</legend>
				<div class="k-grouping-header" data-role="droptarget" style="width: 530px">Submit experiment</div>
				<div id="example" class="k-content">
				<div class="demo-section">
				
					<h3 class="title">Status</h3>
					<div id="progressBar"></div>
					<div class="console"></div>
					<br>

				<br>
				<br>
				</div>
					<button id="startProgress" class="k-button" style="float: right;">Submit</button>
				</div>	
				<br>
				<div class="demo-section">			
					<input type="textbox" id="urlText"  class="k-textbox" style= "width: 400px; font-size: 11.5px; color: grey;" placeholder= "Lifemapper experiment URL" title=""  onkeypress="return noEnter()"/>
				</div>	
				<br><br><br><br>		

				</fieldset>
				</div>
				<div class="modal"></div>

			</div>
		</div>			
	</div>	
	

	


	<!-- PARAMETER GRID -->	
	<!-- Adds algorithm toolbar and dropdownlist to parameter's grid -->
	<script type="text/x-kendo-template" id="template"> 
        <div class="toolbar">
            <label class="category-label" for="category"> Algorithm:</label>
            <input type="search" id="category" style="width: 390px"/>
        </div>
	</script>
	
	
	
	<!-- NO ENTER -->
	<!-- Code to avoid reloading the page when user clicks enter -->
	<script type="text/javascript">
	function noEnter() {
		return !(window.event && window.event.keyCode == 13); 
	}
	function enter(nextfield) {
		if(window.event && window.event.keyCode == 13) {
			nextfield.focus();
			return false; 
		}
		else
			return true; 
	}
		
	/* "Global" variable definition */
	var rectangle, map, infoWindow, infoWindowBox;
	var bounds = new google.maps.LatLngBounds(new google.maps.LatLng(0, 0), new google.maps.LatLng(0, 0)); 
	var ne, sw, nw, se;
	var url = "http://visko.cybershare.utep.edu/sparql?default-graph-uri=&query=";
	
	var userBounds, boundsArray;
	
	//Query URLs (added "=callback?" at the end for JSONP remote data request and binding to kendo widgets)
	var entURL,charURL, sourceURL;
	var speciesURL = url + "prefix+lifemapper%3A+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Felseweb-lifemapper.owl%23%3E%0D%0Aprefix+data%3A+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Felseweb-data.owl%23%3E%0D%0A%0D%0Aselect+%3Fname%0D%0Afrom+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Flinked-data%2Flifemapper%2Foccurrences%2Fspecies-occurrences.owl%3E%0D%0Awhere%7B%0D%0A%3Fdataset+a+lifemapper%3ASpeciesOccurrenceDataset.%0D%0A%3Fdataset+data%3AhasLayer+%3Flayer.%0D%0A%3Fdataset+data%3AhasManifestation+%3Fmanif.%0D%0A%3Fmanif+data%3AhasFileDownloadURL+%3FfileURL.%0D%0A%3Fmanif+data%3AhasLandingPageURL+%3FmetadataURL.%0D%0A%3Flayer+data%3AcontainsFeatureSet+%3Fset.%0D%0A%3Fset+a+lifemapper%3ASpeciesOccurrenceSet.%0D%0A%3Fset+lifemapper%3AhasOccurrenceSetID+%3Fid.%0D%0A%3Fset+lifemapper%3AhasOccurrenceOfSpecies+%3Fspecies.%0D%0A%3Fspecies+lifemapper%3AhasGenusName+%3Fname.%0D%0A%7D%0D%0A&format=application%2Fjson&timeout=0&debug=on&callback?";
	var paramGridURL = url + "prefix+modelling%3A+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Felseweb-modelling.owl%23%3E%0D%0Aprefix+parameters%3A+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Felseweb-lifemapper-parameters.owl%23%3E%0D%0Aprefix+lifemapper%3A+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Felseweb-lifemapper.owl%23%3E%0D%0A%0D%0Aselect+distinct+%3FalgorithmURI+%3FalgorithmName+%3FparamName+%3Fdefault+%3Fminimos+%3Fmaximos+%28datatype%28%3Fdefault%29+as+%3Fdatatype%29%0D%0A%0D%0Afrom+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Flinked-data%2Flifemapper%2Fparameter-descriptions%2Fparameter-descriptions.owl%3E%0D%0Awhere%0D%0A%7B%0D%0A%3FalgorithmURI+a+lifemapper%3ALifemapperAlgorithm.%0D%0A%3FalgorithmURI+modelling%3AhasAlgorithmName+%3FalgorithmName.%0D%0A%3Fparams+lifemapper%3AdescribesBehaviorOf+%3FalgorithmURI.%0D%0A%3Fparams+lifemapper%3AhasParameterDescription+%3FparamDescription.%0D%0A%0D%0A%3FparamDescription+modelling%3AhasParameterName+%3FparamName.%0D%0A%3FparamDescription+lifemapper%3AhasDefaultValue+%3Fdefault.%0D%0Aoptional%7B%3FparamDescription+lifemapper%3AhasLowerBoundInclusive+%3Fminimos.%7D%0D%0Aoptional%7B%3FparamDescription+lifemapper%3AhasUpperBoundInclusive+%3Fmaximos.%7D%0D%0A%7D%0D%0A&format=application%2Fjson&timeout=0&debug=on&callback?";
	var algorithmNameURL = url + "prefix+modelling%3A+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Felseweb-modelling.owl%23%3E%0D%0Aprefix+parameters%3A+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Felseweb-lifemapper-parameters.owl%23%3E%0D%0Aprefix+lifemapper%3A+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Felseweb-lifemapper.owl%23%3E%0D%0A%0D%0Aselect+distinct+%3FalgorithmName%0D%0A%0D%0Afrom+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Flinked-data%2Flifemapper%2Fparameter-descriptions%2Fparameter-descriptions.owl%3E%0D%0Awhere%0D%0A%7B%0D%0A%3FalgorithmURI+a+lifemapper%3ALifemapperAlgorithm.%0D%0A%3FalgorithmURI+modelling%3AhasAlgorithmName+%3FalgorithmName.%0D%0A%3Fparams+lifemapper%3AdescribesBehaviorOf+%3FalgorithmURI.%0D%0A%3Fparams+lifemapper%3AhasParameterDescription+%3FparamDescription.%0D%0A%0D%0A%3FparamDescription+modelling%3AhasParameterName+%3FparamName.%0D%0A%3FparamDescription+lifemapper%3AhasDefaultValue+%3Fdefault.%0D%0Aoptional%7B%3FparamDescription+lifemapper%3AhasLowerBoundInclusive+%3Fmin.%7D%0D%0Aoptional%7B%3FparamDescription+lifemapper%3AhasUpperBoundInclusive+%3Fmax.%7D%0D%0A%7D%0D%0A&format=application%2Fjson&timeout=0&debug=on&callback?";
	var algorithmURI = url + "prefix+modelling%3A+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Felseweb-modelling.owl%23%3E%0D%0Aprefix+parameters%3A+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Felseweb-lifemapper-parameters.owl%23%3E%0D%0Aprefix+lifemapper%3A+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Felseweb-lifemapper.owl%23%3E%0D%0A%0D%0Aselect+distinct+%3FalgorithmURI%0D%0A%0D%0Afrom+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Flinked-data%2Flifemapper%2Fparameter-descriptions%2Fparameter-descriptions.owl%3E%0D%0Awhere%0D%0A%7B%0D%0A%3FalgorithmURI+a+lifemapper%3ALifemapperAlgorithm.%0D%0A%3FalgorithmURI+modelling%3AhasAlgorithmName+%3FalgorithmName.%0D%0A%3Fparams+lifemapper%3AdescribesBehaviorOf+%3FalgorithmURI.%0D%0A%3Fparams+lifemapper%3AhasParameterDescription+%3FparamDescription.%0D%0A%0D%0A%3FparamDescription+modelling%3AhasParameterName+%3FparamName.%0D%0A%3FparamDescription+lifemapper%3AhasDefaultValue+%3Fdefault.%0D%0Aoptional%7B%3FparamDescription+lifemapper%3AhasLowerBoundInclusive+%3Fmin.%7D%0D%0Aoptional%7B%3FparamDescription+lifemapper%3AhasUpperBoundInclusive+%3Fmax.%7D%0D%0A%7D&format=tapplication%2Fjson&timeout=0&debug=on&callback?";
	var maximos = "maximos.value";
    var minimos = "minimos.value";
	var paramGrid;
	
	
		/* GOOGLE MAPS */	
	//Set map properties such as center, zoom, and type 
	function initialize() {
		var mapOptions = {
			center: new google.maps.LatLng(0, 0),
			zoom: 2,
			mapTypeId: google.maps.MapTypeId.SATELLITE
		};
		map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

		// Define the rectangle (bounding box) and set its editable property to true.
		rectangle = new google.maps.Rectangle({
			bounds: bounds,
			editable: true,
			draggable: true,
			fillColor: '#FF9900',
			fillOpacity: .5,
			strokeColor: '#FF9900',
			strokeWeight: 1,
			strokeOpacity: 1
		});
		rectangle.setMap(map);

		// Add an event listener on the rectangle.
		google.maps.event.addListener(rectangle, 'bounds_changed', showNewRect);

		// Define an info window on the map.
		infoWindow = new google.maps.InfoWindow();
		infoWindowBox = new google.maps.InfoWindow();
	}
	
	// Show the new coordinates for the rectangle in an info window and textbox
	// @this {google.maps.Rectangle} 
	function showNewRect(event) {
		ne = rectangle.getBounds().getNorthEast();
		sw = rectangle.getBounds().getSouthWest();
		nw = new google.maps.LatLng(ne.lat(), sw.lng());
		se = new google.maps.LatLng(sw.lat(), ne.lng());
		window.north = ne.lat();
		window.east = ne.lng();
		window.south = sw.lat();
		window.west =	sw.lng();
		
		var contentString = 'NE: ' + north + ', ' + east + '<br>' + 'SW: ' + south + ', ' + west;
		var textboxString = north + ', ' + east + ', ' + south + ', ' + west;

		
		entURL = url + "prefix+elseweb-data%3A+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Felseweb-data.owl%23%3E%0D%0Aprefix+elseweb-edac%3A+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Felseweb-edac.owl%23%3E%0D%0Aselect+distinct+%3Fentity%0D%0Afrom+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Flinked-data%2Fedac%2Fservices%2Fwcs-services.owl%3E%0D%0Awhere%0D%0A%7B%0D%0A%3Fdataset+elseweb-data%3AcoversRegion+%3Fregion.%0D%0A%3Fregion+elseweb-data%3AhasLeftLongitude+%3Fllon.%0D%0A%3Fregion+elseweb-data%3AhasRightLongitude+%3Frlon.%0D%0A%3Fregion+elseweb-data%3AhasLowerLatitude+%3Fllat.%0D%0A%3Fregion+elseweb-data%3AhasUpperLatitude+%3Fulat.%0D%0Afilter%28%3Fllon+%3C%3D+"
					+ west + 
					"%29%0D%0Afilter%28%3Frlon+%3E%3D+"
					+ east + 
					"%29%0D%0Afilter%28%3Fllat+%3C%3D+"
					+ south +
					"%29%0D%0Afilter%28%3Fulat+%3E%3D+"
					+ north + 
					"%29%0D%0A%3Fdataset+elseweb-data%3AhasDataBand+%3Fband.%0D%0A%3Fband+elseweb-data%3ArepresentsEntity+%3Fentity.%0D%0A%0D%0A%7D%0D%0A&format=application%2Fjson&timeout=0&debug=on&callback?";
			
		//Define charURL and sourceURL here to use coordinate variables 
		//TODO: Check variable scope
		charURL = url + "prefix+elseweb-data%3A+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Felseweb-data.owl%23%3E%0D%0Aprefix+elseweb-edac%3A+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Felseweb-edac.owl%23%3E%0D%0Aselect+distinct+%3Fchar%0D%0Afrom+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Flinked-data%2Fedac%2Fservices%2Fwcs-services.owl%3E%0D%0Awhere%0D%0A%7B%0D%0A%3Fdataset+elseweb-data%3AcoversRegion+%3Fregion.%0D%0A%3Fregion+elseweb-data%3AhasLeftLongitude+%3Fllon.%0D%0A%3Fregion+elseweb-data%3AhasRightLongitude+%3Frlon.%0D%0A%3Fregion+elseweb-data%3AhasLowerLatitude+%3Fllat.%0D%0A%3Fregion+elseweb-data%3AhasUpperLatitude+%3Fulat.%0D%0A%0D%0Afilter%28%3Fllon+%3C%3D+"
					+ west +
					"%29%0D%0Afilter%28%3Frlon+%3E%3D+"
					+ east +
					"%29%0D%0Afilter%28%3Fllat+%3C%3D+"
					+ south +
					"%29%0D%0Afilter%28%3Fulat+%3E%3D+"
					+ north +
					"%29%0D%0A%0D%0A%3Fdataset+elseweb-data%3AhasDataBand+%3Fband.%0D%0A%3Fband+elseweb-data%3AencodingOfCharacteristic+%3Fchar%0D%0A%7D%0D%0A&format=application%2Fjson&timeout=0&debug=on&callback?";
		
		sourceURL = url + "define+input%3Ainference+%22http%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Fmappings%2Felseweb-edac-mappings.owl%22%0D%0Aprefix+elseweb-data%3A+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Felseweb-data.owl%23%3E%0D%0Aprefix+elseweb-edac%3A+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Felseweb-edac.owl%23%3E%0D%0Aprefix+provo%3A+%3Chttp%3A%2F%2Fwww.w3.org%2Fns%2Fprov%23%3E%0D%0Aselect+distinct+%3Fsource%0D%0Afrom+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Flinked-data%2Fedac%2Fservices%2Fwcs-services.owl%3E%0D%0Awhere%0D%0A%7B%0D%0A%3Fdataset+elseweb-data%3AcoversRegion+%3Fregion.%0D%0A%3Fregion+elseweb-data%3AhasLeftLongitude+%3Fllon.%0D%0A%3Fregion+elseweb-data%3AhasRightLongitude+%3Frlon.%0D%0A%3Fregion+elseweb-data%3AhasLowerLatitude+%3Fllat.%0D%0A%3Fregion+elseweb-data%3AhasUpperLatitude+%3Fulat.%0D%0A%0D%0Afilter%28%3Fllon+%3C%3D+"
					+ west +
					"%29%0D%0Afilter%28%3Frlon+%3E%3D+"
					+ east +
					"%29%0D%0Afilter%28%3Fllat+%3C%3D+"
					+ south +
					"%29%0D%0Afilter%28%3Fulat+%3E%3D+"
					+ north +
					"%29%0D%0A%0D%0A%3Fdataset+elseweb-data%3AhasDataBand+%3Fband.%0D%0A%3Fband+provo%3AwasGeneratedBy+%3Factivity.%0D%0A%3Factivity+provo%3AwasAssociatedWith+%3Fsource%0D%0A%7D%0D%0A&format=application%2Fjson&timeout=0&debug=on&callback?";
	
			
		// Set the info window's content and position.
		// Change textbox value 
		document.getElementById("boundsText").value = textboxString;
		
		//Request to check if there is any data in the selected region using the entity query URL and display infoWindow in the map.
		$.ajax({  
			type: "GET",
			url: entURL,  
			dataType: "jsonp",  
			success: function(data) { 
				if(data.results.bindings == ""){
					infoWindow.setContent('<div><div style="color:#FF0000; font-size:13px; font-weight:bold;width:100%;">' + "No data available. Please change coordinates" +  '<br></div></div>' + contentString );
					infoWindow.setPosition(ne);

					infoWindow.open(map);
				}
				else{
					infoWindow.setContent('<div><div style="color:#000000; font-size:13px; font-weight:bold;width:100%;">' + "Data available" + '<br></div></div>' + contentString);
					infoWindow.setPosition(ne);

					infoWindow.open(map);
				}			
			}  
		}); 
	}
	
	//gets user input and creates a rectangle with given bounds
	function changeBounds(){
		userBounds = document.getElementById("boundsText").value;
		boundsArray = userBounds.split(",");
			north = boundsArray[0];
			east = boundsArray[1];
			south = boundsArray[2];
			west = boundsArray[3];
		
		bounds = new google.maps.LatLngBounds(
			new google.maps.LatLng(south, west),
			new google.maps.LatLng(north, east)
		);
		initialize();
	}
	
	//Displays the map
	google.maps.event.addDomListener(window, 'load', initialize);	
	
	
	/* WINDOW PROPERTIES */
	$(document).ready(function () {
		var window = $("#window"),
            undo = $("#undo")
            .bind("click", function() {
				window.data("kendoWindow").open();
				undo.hide();
            });

			var onClose = function() {
				undo.show();
            }

            if (!window.data("kendoWindow")) {
				window.kendoWindow({
					width: "1890px",
					height: "708px",
					scrollable: false,
					draggable: true,
					resizable: false,
					title: "ELSEWeb",
					visible: false,
					actions: [
						"Minimize",
                        "Close"
					],
					close: onClose
                });
				window.data("kendoWindow").center();
				window.data("kendoWindow").open();
            }

		
	
	/* SPLITTER */
	<!-- Panes to divide window into 3 sections (Region/Species, Data/Algorithm, and Model)-->

		$("#horizontal").kendoSplitter({
			panes: [
				{ collapsible: false, resizable: false, size: "670px"},
				{ collapsible: false, resizable: false, size: "630px"},
				{ collapsible: false, resizable: false, size: "550px"}
			]
		});
   

	
	/* PROGRESS BAR */
	
        $("#progressBar").kendoProgressBar({
            type: "chunk",
            chunkCount: 4,
            min: 0,
            max: 5,
            value: 0,
			change:onChange,
            complete: onComplete
        });
 

        function onChange(e) {
			kendoConsole.log(" -------------------------  ");
        }

        function onComplete(e) {
            $("#startProgress").text("Done");
        }

        $("#startProgress").click(function () {
            if (!$(this).hasClass("k-state-disabled")) {
                $(this).addClass("k-state-disabled");
                progress();
            }
        });

        function progress() {
			$(".title").html("SERVICE ORCHESTRATION STAGE");
			var pb = $("#progressBar").data("kendoProgressBar");
			pb.value(0);
			pb.value(1);
			getExpURL();
			pb.value(5);
			
			var interval = setInterval(function () {
				if (pb.value() < 10) {
					pb.value(pb.value() + 1);
				} else {
					clearInterval(interval);
				}
			}, 100);
		}
	
	

	
	
	/* DATA GRID */	
	//TODO: Change entURL to include start and end date (cascade)
	//TODO: Change charURL and add selected entity (cascade) 
	//TODO: Change sourceURL and add selected characteristic (cascade) 
	
		

		//Creating datasource structure for data grid.
		//TODO: After adding cascade functionality, add validation to each field (use kendo notification ui widget)
        dataSource = new kendo.data.DataSource({
			data: [],
			pageSize: 5,
            schema: {
            model: {
            id: "DataSetID",
            fields: {
                DataSetID: { editable: false, nullable: true },
				StartDate: { validation: { required: false } },
                EndDate: { validation: { required: false } },
                EntityName: { validation: { required: false } },
				CharacteristicName: { validation: { required: false } },
				SourceName: { validation: { required: false } },
					}
				}
			}
		});

		/*
		*	Trying to create a function to add cascade functionality to grid. (Use Kendo Grid CURRENT, SETDATASOURCE, COLUMN EDITOR methods and Datasource CHANGE, BIND, and FETCH methods combined with Dropdownlist methods)
	    *	Grid documentation: http://docs.telerik.com/kendo-ui/api/web/grid#methods-setDataSource
		* 	Datasource documentation: http://docs.telerik.com/kendo-ui/api/framework/datasource#events-change
		*  	Dropdownlist documentation: http://docs.telerik.com/kendo-ui/api/web/dropdownlist
		
		function onChange(arg) {
			var selected = $.map(this.select(), function(item) {
			return $(item).text();
        });

			kendoConsole.log("Selected: " + selected.length + " item(s), [" + selected.join(", ") + "]");
        }
		*/
		

		//Editors to populate grid		
		function dateEditor(container, options) {
			$('<input data-text-field= " ' + options.field + '" data-value-field="' + options.field + '" data-bind="value:' + options.field + '"/>').appendTo(container).kendoDatePicker({});
		}
		
		//Entity dropdownlist inside data grid	
		function entityDropDownEditor(container, options) {
			$('<input required data-text-field="entity.value.slice(59)" data-value-field="entity.id" data-bind="value:' + options.field + '"/>')
			.appendTo(container)
			.kendoDropDownList({
				autoBind: true,
				dataTextField: "entity.value.slice(59)",  //gets entity section from bindings in json's query result, then slice it to show only the entity name and not the URI
				dataValueField: "entity.id",								
				dataSource: {
					transport: {
						read: {
							dataType: 'jsonp',  //JSONP to bind remote data
							url:entURL  //TODO: change to add selected dates
						}
					},	
					schema: {
						data: "results.bindings" //Get "bindings" section of the json's query result
					}
				},
				optionLabel: { "entity": {"value": "http://visko.cybershare.utep.edu/linked-data/edac/services/-- select --"}}	
			});
		}
					
		//Characteristic dropdownlist inside data grid					
		function charDropDownEditor(container, options) {
			$('<input required data-text-field="char.value.slice(59)" data-value-field="char.id" data-bind="value:' + options.field + '"/>')
			.appendTo(container)
			.kendoDropDownList({
				autoBind: true,
				dataTextField: "char.value.slice(59)",
				dataValueField: "char.id",
				dataSource: {
					transport: {
						read: {
							dataType: 'jsonp',
							url: charURL	//TODO: Change to add dates and selected entity
						}
					},	
					schema: {
						data: "results.bindings"
					}
				},
				optionLabel: { "char": {"value": "http://visko.cybershare.utep.edu/linked-data/edac/services/-- select --"}}	
			});
		}	
					

		//Source dropdownlist inside data grid				
		function sourceDropDownEditor(container, options) {
			$('<input required data-text-field="source.value.slice(59)" data-value-field="source.id" data-bind="value:' + options.field + '"/>')
			.appendTo(container)
			.kendoDropDownList({
				autoBind: true,
				dataTextField: "source.value.slice(59)",
				dataValueField: "source.id",
				dataSource: {
					transport: {
						read: {
							dataType: 'jsonp',
							url:sourceURL	//Change to add selected characteristics to the query
						}
					},	
					schema: {
						data: "results.bindings"
					}
				},
				optionLabel: { "source": {"value": "http://visko.cybershare.utep.edu/linked-data/edac/services/-- select --"}}	
			});
		}						
		
		//Grid populated with previously defined datasource and editors.
        $("#grid").kendoGrid({
            dataSource: dataSource,
            pageable: false,
			scrollable: true,	
            height: 300,
            toolbar: [{ name: "create", text: "Add data set"}],
			autoBind: false,
            columns: [
				{ field: "start", title:"Start", width: "50px", editor: dateEditor, format: "{0:yyyy-MM-dd}" },
				{ field: "end", title:"End", width: "50px", editor: dateEditor, format: "{0:yyyy-MM-dd}"  },
				{ field:"entity", title: "Entity", width: "55px", editor: entityDropDownEditor },
                { field: "characteristic", title:"Characteristic", width: "63px", editor: charDropDownEditor  },
                { field: "source", title:"Source", width: "55px", editor: sourceDropDownEditor  },
				{ command: [ { className: "k-delete-button", name: "destroy", text:""}], title: "&nbsp;", width: "37px" }
			],
            editable: true
        });
		
		dataSource.fetch();
 

	
	/* SPECIES */	
	//Species file upload
	//File Upload documentation: http://demos.telerik.com/kendo-ui/web/upload/index.html 
	//http://docs.telerik.com/kendo-ui/api/web/upload
	
        $("#files").kendoUpload({
			localization: {
				select: "Browse:"
			},
			enabled: true
		});
    
		
	//Species autocomplete combobox
	
		$("#species").kendoComboBox({
			dataTextField: "name.value",
			enabled: true,
			autoBind: true,
			dataSource: {
				transport: {
					read: {
						dataType: "jsonp", //Binding remote date
						url: speciesURL 
					}
				},
				schema: {
					data: "results.bindings"
				}               
			},
			placeholder: "-- start typing to find species --"
		});
		
	//Get user selected species from species combobox
	var speciesCombobox = $("#species").data("kendoComboBox");
	window.selectedSpecies = speciesCombobox.dataItem();
	});
	
	$(document).ready(function() {
    /* PARAMETER GRID */
		//Data contained in grid
		paramDataSource = new kendo.data.DataSource({
            transport: {
                read: {
					dataType: "jsonp",
					//AlgorithmName, ALgorithmURI, Parameters, min value, max, value, and default query url
					url: paramGridURL
				}
			},
            schema: {
				data: "results.bindings", //gets json bindings section
				total: "count",
				model: {
					fields: {
						"paramName.value": { editable: false, nullable: false }, //gets json paraName value
						"default.value": { type: "number", editable: true, nullable: false }, //editable set to true to modify parameter's value
						"mini": { editable: false },
						"maxi": { editable: false },
						"datatype.value.slice(33)": { editable: false, nullable: false }
					}
				}
            }
        }); 
		
		//PARAMETER GRID with paramDataSource	

		 paramGrid = $("#parameterGrid").kendoGrid({
            dataSource: [], //no datasource until setDataSource method is called in order to populate grid with filtered data by selected algorithm
			toolbar: kendo.template($("#template").html()), //created a template to add the Algorithmn's dropdownlist bar on top of grid's columns
            height: 250,
            columns: [
				{ field:"paramName.value", title: "Parameter", width: 100},
				{ field:"default.value", title: "Value", width: 100},
				{ field: "mini", title: "Min", width: 100, template:"#= (minimos == 'undefined') ? minimos = 25 : minimos.value #"},
				{ field: "maxi", title: "Max", width: 100, template:"#= (maximos == 'undefined') ? maximos = 25 : maximos.value #"},
				{ field:"datatype.value.slice(33)", title: "Type", width: 100}
			],
			editable: true
        });
					
		//Dropdownlist with algorithms					
		var dropDown = paramGrid.find("#category").kendoDropDownList({
            dataTextField: "algorithmURI.value.slice(79)",
            dataValueField: "algorithmURI.value",
            autoBind: true,
            dataSource: {
                transport: {
                    read: {
                        dataType: "jsonp",
                        //Algorithm query URL
						url: algorithmURI
					}
				},
				schema: {
					data: "results.bindings"
				}               
            },
			optionLabel: { "algorithmURI": {"value": "http://visko.cybershare.utep.edu/linked-data/lifemapper/parameter-descriptions/---------------- please select ----------------"}},	
            change: function() {
				//Get selected Algorithm
                var value = this.value();
                //Populate grid with paramDatasource filtered by comparing the selected algorithm and algorithmName value in paramGridURL
				if (value) {
					paramGrid.data("kendoGrid").setDataSource(paramDataSource);
                    paramGrid.data("kendoGrid").dataSource.filter({ field: "algorithmURI.value", operator: "eq", value: value });
				} else {
                    paramGrid.data("kendoGrid").dataSource.filter({});
                }
            }
        });
	});	
	

	
	/* MODEL SECTION AND OUTPUT */
	
	//Testing coordinate variables
	//kendoConsole.log("N: " + north + "S: " + south+ "E: " + east + "W: " + west);
	$(document).ready(function() {
	var modelDataSets = new Array();
	var modelingScenarioJSONStr, algorithmJSONStr, algorithmID, parameterJSONStr, speciesOccurrenceID;	
	var jsonSpec;
	
	//Global User ID generator
	function guidGenerator() {
		var S4 = function() {
			return (((1+Math.random())*0x10000)|0).toString(16).substring(1);
		};
		return (S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4());
	}
	
	/*This function iterates through the data grid rows and retrieves all the data grid selected values and stores them in an array.
	Then, it uses the stored data to create dataset queries	and uses the results to form the json modeling scenario section. */
	
		var sDate, eDate, entitySel, entStr, eInd, characSel, charStr, cInd, sourceSel, souStr, sInd;  
		var sDateA = new Array();
		var eDateA = new Array();
		var entA = new Array();
		var charA = new Array();
		var souA = new Array();
		
		var items = $("#grid").data("kendoGrid").dataSource.data();
			for (i = 0; i < items.length; i++) {
				//Get start date values from each row and store in an array
				sDate = (JSON.stringify(items[i].start).substr(1,10) + "-00");
				sDateA[i] = sDate;
				//Get end date values from each row and store in an array
				eDate = (JSON.stringify(items[i].end)).substr(1,10) + "-00";
				eDateA[i] = eDate;
				//Get entity values from each row, convert back into a url, and and store in an array
				entStr = JSON.stringify(items[i].entity);
				eInd = entStr.length - 2;
				entitySel = "http://visko.cybershare.utep.edu/linked-data/edac/services/" + entStr.substr(1,eInd);
				entA[i] = entitySel;  
				//Get characteristic values from each row, convert back into a url, and and store in an array
				charStr = JSON.stringify(items[i].characteristic);
				cInd = charStr.length - 2;	
				characSel = "http://visko.cybershare.utep.edu/linked-data/edac/services/" + charStr.substr(1,cInd);
				charA[i] = characSel;
				//Get source values from each row, convert back into a url, and and store in an array
				souStr = JSON.stringify(items[i].source);
				sInd = souStr.length - 2;
				sourceSel =  "http://visko.cybershare.utep.edu/linked-data/edac/services/" + souStr.substr(1,sInd);
				souA[i] = sourceSel;
				
				//Print each value in model console		
				kendoConsole.log("READING ROW #" + (i + 1))
				kendoConsole.log("Getting selected start date :: " + sDateA[i] );
				kendoConsole.log("Getting selected end date :: " + eDateA[i] );
				kendoConsole.log("Getting selected entity :: " + entA[i].slice(59) );
				kendoConsole.log("Getting selected characteristic :: " + charA[i].slice(59) );
				kendoConsole.log("Getting selected source :: " + souA[i].slice(59) );
				kendoConsole.log("DATA SET #" + (i+1) + " COMPLETED" );
						

				$(".title").html("WAITING ON MODEL RESPONSE STAGE");
				kendoConsole.log("MODEL RESPONSE...");				
				$(".title").html("MODEL SUBMISSION STAGE");	
				
				//Testing coordinate variables
				kendoConsole.log("N: " + north + "S: " + south+ "E: " + east + "W: " + west);
				
				//Construct dataset query URL with each row's selected values
				//TODO: Change coordinate values to variables 
				
				var datasetURL = url + 
				"define+input%3Ainference+%22http%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Fmappings%2Felseweb-edac-mappings.owl%22%0D%0Aprefix+elseweb-data%3A+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Felseweb-data.owl%23%3E%0D%0Aprefix+elseweb-edac%3A+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Felseweb-edac.owl%23%3E%0D%0Aprefix+provo%3A+%3Chttp%3A%2F%2Fwww.w3.org%2Fns%2Fprov%23%3E%0D%0A%0D%0Aselect+distinct+%3Fdataset%0D%0Afrom+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Flinked-data%2Fedac%2Fservices%2Fwcs-services.owl%3E%0D%0Awhere%0D%0A%7B%0D%0A%3Fdataset+elseweb-data%3AcoversRegion+%3Fregion.%0D%0A%3Fregion+elseweb-data%3AhasLeftLongitude+%3Fllon.%0D%0A%3Fregion+elseweb-data%3AhasRightLongitude+%3Frlon.%0D%0A%3Fregion+elseweb-data%3AhasLowerLatitude+%3Fllat.%0D%0A%3Fregion+elseweb-data%3AhasUpperLatitude+%3Fulat.%0D%0A%0D%0Afilter%28%3Fllon+%3C%3D+"
				+ "-123.05" +
				"%29%0D%0Afilter%28%3Frlon+%3E%3D+"
				+ "-80.19" +
				"%29%0D%0Afilter%28%3Fllat+%3C%3D+"
				+ "24.20" +
				"%29%0D%0Afilter%28%3Fulat+%3E%3D+"
				+ "49.03" +
				"%29%0D%0A%0D%0A%3Fdataset+elseweb-data%3AcoversTimePeriod+%3Fperiod.%0D%0A%3Fperiod+elseweb-data%3AhasStartDate+%3FstartDate.%0D%0A%3Fperiod+elseweb-data%3AhasEndDate+%3FendDate.%0D%0A%0D%0A%3FstartDate+elseweb-data%3AhasDateTime+%3FsDate.%0D%0A%3FendDate+elseweb-data%3AhasDateTime+%3FeDate.%0D%0A%0D%0Afilter%28%3FsDate+%3E%3D+%22"
				+ sDate[i] +
				"%3A00%22%5E%5Exsd%3AdateTime%29%0D%0Afilter%28%3FeDate+%3C%3D+%22"
				+ eDate[i] +
				"%3A00%22%5E%5Exsd%3AdateTime%29+%0D%0A%0D%0A%3Fdataset+elseweb-data%3AhasDataBand+%3Fband.%0D%0A%3Fband+elseweb-data%3ArepresentsEntity+%3Chttp%3A%2F%2Fvisko.cybershare.utep.edu%2Flinked-data%2Fedac%2Fservices%2F"
				+ entA[i].slice(59) +
				"%3E.%0D%0A%3Fband+elseweb-data%3AencodingOfCharacteristic+%3Chttp%3A%2F%2Fvisko.cybershare.utep.edu%2Flinked-data%2Fedac%2Fservices%2F"
				+ charA[i].slice(59) +
				"%3E.%0D%0A%3Fband+provo%3AwasGeneratedBy+%3Factivity.%0D%0A%3Factivity+provo%3AwasAssociatedWith+%3Chttp%3A%2F%2Fvisko.cybershare.utep.edu%2Flinked-data%2Fedac%2Fservices%2F"
				+ souA[i].slice(59) +
				"%3E%0D%0A%0D%0A%7D&format=application%2Fjson&timeout=0&debug=on&callback?";
				
				//Dataset Query
				$.ajax({
					type: "GET",
					url: datasetURL,  
					dataType: "jsonp",  
					success: function(data) { 
						if((data.results.bindings[0].dataset.value == "") || (data.results.bindings[0].dataset.value == 'undefined' )){
							alert("No datasets match criteria. Change values.")
							kendoConsole.log("No datasets match criteria. Change values.");
						}
						else{
							kendoConsole.log("SENDING DATA SET QUERY...")
							kendoConsole.log("Waiting for dataset...")
							kendoConsole.log("DATA SET RETURNED :: " + (JSON.stringify(data.results.bindings[0].dataset.value)));
							modelDataSets[i] = JSON.stringify(data.results.bindings[0].dataset.value);
						}			
					}	  
				});	
				//store all datasets to append to jsonSpec string	
				modelingScenarioJSONStr += '"datasetURI":' + '"' + modelDataSets[i] + '"},'; 
			}
			
			kendoConsole.log(modelingScenarioJSONStr);

		

		
	//This function iterates through all the parameter's grid rows and retrieves the selected data, constructs and returns the jsonSpec algorithm data section. 
	function getAlgorithmData() {			
		var algItems = $("#paramGrid").data("kendoGrid").dataSource.view();
		algorithmID = algItems[1].algorithmName.value;
		kendoConsole.log("Selected Algorithm :: " + algorithmID);
		for (i = 0; i < algItems.length; i++) {		
		        kendoConsole.log("READING PARAMETER DATA...");
				kendoConsole.log("Getting parameter name :: " + algItems[i].paramName.value);
				kendoConsole.log("Getting parameter value :: " + algItems[i].default.value);
				kendoConsole.log("Getting parameter datatype :: " + algItems[i].datatype.value.slice(33));
		        parameterJSONStr +=	'{"name": "' +  algItems[i].paramName.value + '", "value": "' + algItems[i].default.value + '", "datatype": "' + algItems[i].datatype.value.slice(33) + '"},';	
		}
		algorithmJSONStr = '"algorithm": {"id": "' + algorithmID + '",' + parameterJSONStr.substr(0, str.length-1);
		return algorithmJSONStr;
	}
	

	var sOccurrenceURL = url + "prefix+lifemapper%3A+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Felseweb-lifemapper.owl%23%3E%0D%0Aprefix+data%3A+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Felseweb-data.owl%23%3E%0D%0A%0D%0Aselect+%3Fid%0D%0Afrom+%3Chttp%3A%2F%2Fontology.cybershare.utep.edu%2FELSEWeb%2Flinked-data%2Flifemapper%2Foccurrences%2Fspecies-occurrences.owl%3E%0D%0Awhere%7B%0D%0A%3Fdataset+a+lifemapper%3ASpeciesOccurrenceDataset.%0D%0A%3Fdataset+data%3AhasLayer+%3Flayer.%0D%0A%3Fdataset+data%3AhasManifestation+%3Fmanif.%0D%0A%3Fmanif+data%3AhasFileDownloadURL+%3FfileURL.%0D%0A%3Fmanif+data%3AhasLandingPageURL+%3FmetadataURL.%0D%0A%3Flayer+data%3AcontainsFeatureSet+%3Fset.%0D%0A%3Fset+a+lifemapper%3ASpeciesOccurrenceSet.%0D%0A%3Fset+lifemapper%3AhasOccurrenceSetID+%3Fid.%0D%0A%3Fset+lifemapper%3AhasOccurrenceOfSpecies+%3Fspecies.%0D%0A%3Fspecies+lifemapper%3AhasGenusName+%22" + "Agrypon" + "%22%5E%5E%3Chttp%3A%2F%2Fwww.w3.org%2F2001%2FXMLSchema%23string%3E.%0D%0A%7D%0D%0A&format=application%2Fjson&timeout=0&debug=on&callback?";
	//This function gets species occurrence query url and requests and occurrence ID.
	//This is a callback function that gets species occurrence query url and requests and occurrence ID.
	/*function getOccurrenceID(callback){ 
		$.ajax({
			type: "GET",
			url: sOccurrenceURL, 
			async: false,	
			dataType: "jsonp",  
			success: function(data) { 
				kendoConsole.log("SPECIES OCCURRENCE")
				kendoConsole.log("Waiting for request...")
				kendoConsole.log("Occurrence Id returned :: " + (JSON.stringify(data.results.bindings[0].id.value)));
				if (typeof callback=="function") return callback(data);
			}			
		});
	}

	getOccurrenceID(function(speciesOccurrenceID) {
		var occ = JSON.stringify(speciesOccurrenceID.results.bindings[0].id.value)
		//alert(occ);
		return occ;
	});
	*/
	
              				
	//This function puts together all the pieces to construct the json string that it going to be sent to the Lifemapper experiment request
	function getJSONSpec(){
		jsonSpec = '{"specification": {"id": "' +  guidGenerator() 
		+ '","occurrenceDataID": ' + '"100667"';
		console.log(jsonSpec);
		return jsonSpec;
	}
	
	//jsonSpec for testing purposes
	var jsonSpec2 = '{"specification": {' + 
    '"id": "d046d1fa-98cc-4705-b44d-884c263bbcfa",' +
    '"occurrenceDataID": "1032789",' +
    '"algorithm": {' +
        '"id": "ANN",' +
        '"parameterBindings": [' +
            '{"name": "Choice", "value": "1", "datatype": "integer"},' +
            '{"name": "Epoch", "value": "5000000", "datatype": "integer"},' +
            '{"name": "HiddenLayerNeurons", "value": "14", "datatype": "integer"},' +
            '{"name": "LearningRate", "value": "0.3", "datatype": "double"},' +
            '{"name": "MinimumError", "value": "0.01", "datatype": "double"},' +
            '{"name": "Momentum", "value": "0.05", "datatype": "double"}' +         
            ']' +
    '},' +
    '"modelingScenario": [' +
        '{"datasetURI": "http://visko.cybershare.utep.edu/linked-data/edac/services/dataset_348880"},' +
        '{"datasetURI": "http://visko.cybershare.utep.edu/linked-data/edac/services/dataset_348881"},' +
        '{"datasetURI": "http://visko.cybershare.utep.edu/linked-data/edac/services/dataset_348882"},' + 
        '{"datasetURI": "http://visko.cybershare.utep.edu/linked-data/edac/services/dataset_348883"},' +
        '{"datasetURI": "http://visko.cybershare.utep.edu/linked-data/edac/services/dataset_348884"}' +
        ']' +
    '}' +
'}';

	
	var serviceURL = 'http://visko.cybershare.utep.edu/elseweb-endpoint/JSONSpecification?jsonSpec=' + jsonSpec2;
	//Lifemapper experiment request
	var expURL;
	function getExpURL(){
		var xmlhttp;
		if (window.XMLHttpRequest){// code for IE7+, Firefox, Chrome, Opera, Safari
			xmlhttp=new XMLHttpRequest();
		}
		xmlhttp.onreadystatechange=function(){
			if (xmlhttp.readyState==4 && xmlhttp.status==200){
				expURL = xmlhttp.responseText.substr(205, 54);
				document.getElementById("urlText").innerHTML=expURL;
				
			}
		}
		xmlhttp.open("POST",serviceURL,true);
		xmlhttp.send();	
		$(".title").html("LIFEMAPPER EXPERIMENT URL")
	}
});

    </script>
	<script>
		$body = $("body");

$(document).on({
    ajaxStart: function() { $body.addClass("loading");    },
     ajaxStop: function() { $body.removeClass("loading"); }    
});

// Initiates an AJAX request on click
$(document).on("click", function(){
    $.get("/mockjax");        
});

/*!
 * MockJax - jQuery Plugin to Mock Ajax requests
 *
 * Version:  1.5.3
 * Released:
 * Home:   http://github.com/appendto/jquery-mockjax
 * Author:   Jonathan Sharp (http://jdsharp.com)
 * License:  MIT,GPL
 *
 * Copyright (c) 2011 appendTo LLC.
 * Dual licensed under the MIT or GPL licenses.
 * http://appendto.com/open-source-licenses
 */ (function($) {
    var _ajax = $.ajax,
        mockHandlers = [],
        mockedAjaxCalls = [],
        CALLBACK_REGEX = /=\?(&|$)/,
        jsc = (new Date()).getTime();


    // Parse the given XML string.
    function parseXML(xml) {
        if (window.DOMParser == undefined && window.ActiveXObject) {
            DOMParser = function() {};
            DOMParser.prototype.parseFromString = function(xmlString) {
                var doc = new ActiveXObject('Microsoft.XMLDOM');
                doc.async = 'false';
                doc.loadXML(xmlString);
                return doc;
            };
        }

        try {
            var xmlDoc = (new DOMParser()).parseFromString(xml, 'text/xml');
            if ($.isXMLDoc(xmlDoc)) {
                var err = $('parsererror', xmlDoc);
                if (err.length == 1) {
                    throw ('Error: ' + $(xmlDoc).text());
                }
            } else {
                throw ('Unable to parse XML');
            }
            return xmlDoc;
        } catch (e) {
            var msg = (e.name == undefined ? e : e.name + ': ' + e.message);
            $(document).trigger('xmlParseError', [msg]);
            return undefined;
        }
    }

    // Trigger a jQuery event
    function trigger(s, type, args) {
        (s.context ? $(s.context) : $.event).trigger(type, args);
    }

    // Check if the data field on the mock handler and the request match. This
    // can be used to restrict a mock handler to being used only when a certain
    // set of data is passed to it.
    function isMockDataEqual(mock, live) {
        var identical = true;
        // Test for situations where the data is a querystring (not an object)
        if (typeof live === 'string') {
            // Querystring may be a regex
            return $.isFunction(mock.test) ? mock.test(live) : mock == live;
        }
        $.each(mock, function(k) {
            if (live[k] === undefined) {
                identical = false;
                return identical;
            } else {
                // This will allow to compare Arrays
                if (typeof live[k] === 'object' && live[k] !== null) {
                    identical = identical && isMockDataEqual(mock[k], live[k]);
                } else {
                    if (mock[k] && $.isFunction(mock[k].test)) {
                        identical = identical && mock[k].test(live[k]);
                    } else {
                        identical = identical && (mock[k] == live[k]);
                    }
                }
            }
        });

        return identical;
    }

    // See if a mock handler property matches the default settings
    function isDefaultSetting(handler, property) {
        return handler[property] === $.mockjaxSettings[property];
    }

    // Check the given handler should mock the given request
    function getMockForRequest(handler, requestSettings) {
        // If the mock was registered with a function, let the function decide if we
        // want to mock this request
        if ($.isFunction(handler)) {
            return handler(requestSettings);
        }

        // Inspect the URL of the request and check if the mock handler's url
        // matches the url for this ajax request
        if ($.isFunction(handler.url.test)) {
            // The user provided a regex for the url, test it
            if (!handler.url.test(requestSettings.url)) {
                return null;
            }
        } else {
            // Look for a simple wildcard '*' or a direct URL match
            var star = handler.url.indexOf('*');
            if (handler.url !== requestSettings.url && star === -1 || !new RegExp(handler.url.replace(/[-[\]{}()+?.,\\^$|#\s]/g, "\\$&").replace(/\*/g, '.+')).test(requestSettings.url)) {
                return null;
            }
        }

        // Inspect the data submitted in the request (either POST body or GET query string)
        if (handler.data && requestSettings.data) {
            if (!isMockDataEqual(handler.data, requestSettings.data)) {
                // They're not identical, do not mock this request
                return null;
            }
        }
        // Inspect the request type
        if (handler && handler.type && handler.type.toLowerCase() != requestSettings.type.toLowerCase()) {
            // The request type doesn't match (GET vs. POST)
            return null;
        }

        return handler;
    }

    // Process the xhr objects send operation
    function _xhrSend(mockHandler, requestSettings, origSettings) {

        // This is a substitute for < 1.4 which lacks $.proxy
        var process = (function(that) {
            return function() {
                return (function() {
                    var onReady;

                    // The request has returned
                    this.status = mockHandler.status;
                    this.statusText = mockHandler.statusText;
                    this.readyState = 4;

                    // We have an executable function, call it to give
                    // the mock handler a chance to update it's data
                    if ($.isFunction(mockHandler.response)) {
                        mockHandler.response(origSettings);
                    }
                    // Copy over our mock to our xhr object before passing control back to
                    // jQuery's onreadystatechange callback
                    if (requestSettings.dataType == 'json' && (typeof mockHandler.responseText == 'object')) {
                        this.responseText = JSON.stringify(mockHandler.responseText);
                    } else if (requestSettings.dataType == 'xml') {
                        if (typeof mockHandler.responseXML == 'string') {
                            this.responseXML = parseXML(mockHandler.responseXML);
                            //in jQuery 1.9.1+, responseXML is processed differently and relies on responseText
                            this.responseText = mockHandler.responseXML;
                        } else {
                            this.responseXML = mockHandler.responseXML;
                        }
                    } else {
                        this.responseText = mockHandler.responseText;
                    }
                    if (typeof mockHandler.status == 'number' || typeof mockHandler.status == 'string') {
                        this.status = mockHandler.status;
                    }
                    if (typeof mockHandler.statusText === "string") {
                        this.statusText = mockHandler.statusText;
                    }
                    // jQuery 2.0 renamed onreadystatechange to onload
                    onReady = this.onreadystatechange || this.onload;

                    // jQuery < 1.4 doesn't have onreadystate change for xhr
                    if ($.isFunction(onReady)) {
                        if (mockHandler.isTimeout) {
                            this.status = -1;
                        }
                        onReady.call(this, mockHandler.isTimeout ? 'timeout' : undefined);
                    } else if (mockHandler.isTimeout) {
                        // Fix for 1.3.2 timeout to keep success from firing.
                        this.status = -1;
                    }
                }).apply(that);
            };
        })(this);

        if (mockHandler.proxy) {
            // We're proxying this request and loading in an external file instead
            _ajax({
                global: false,
                url: mockHandler.proxy,
                type: mockHandler.proxyType,
                data: mockHandler.data,
                dataType: requestSettings.dataType === "script" ? "text/plain" : requestSettings.dataType,
                complete: function(xhr) {
                    mockHandler.responseXML = xhr.responseXML;
                    mockHandler.responseText = xhr.responseText;
                    // Don't override the handler status/statusText if it's specified by the config
                    if (isDefaultSetting(mockHandler, 'status')) {
                        mockHandler.status = xhr.status;
                    }
                    if (isDefaultSetting(mockHandler, 'statusText')) {
                        mockHandler.statusText = xhr.statusText;
                    }

                    this.responseTimer = setTimeout(process, mockHandler.responseTime || 0);
                }
            });
        } else {
            // type == 'POST' || 'GET' || 'DELETE'
            if (requestSettings.async === false) {
                // TODO: Blocking delay
                process();
            } else {
                this.responseTimer = setTimeout(process, mockHandler.responseTime || 50);
            }
        }
    }

    // Construct a mocked XHR Object
    function xhr(mockHandler, requestSettings, origSettings, origHandler) {
        // Extend with our default mockjax settings
        mockHandler = $.extend(true, {}, $.mockjaxSettings, mockHandler);

        if (typeof mockHandler.headers === 'undefined') {
            mockHandler.headers = {};
        }
        if (mockHandler.contentType) {
            mockHandler.headers['content-type'] = mockHandler.contentType;
        }

        return {
            status: mockHandler.status,
            statusText: mockHandler.statusText,
            readyState: 1,
            open: function() {},
            send: function() {
                origHandler.fired = true;
                _xhrSend.call(this, mockHandler, requestSettings, origSettings);
            },
            abort: function() {
                clearTimeout(this.responseTimer);
            },
            setRequestHeader: function(header, value) {
                mockHandler.headers[header] = value;
            },
            getResponseHeader: function(header) {
                // 'Last-modified', 'Etag', 'content-type' are all checked by jQuery
                if (mockHandler.headers && mockHandler.headers[header]) {
                    // Return arbitrary headers
                    return mockHandler.headers[header];
                } else if (header.toLowerCase() == 'last-modified') {
                    return mockHandler.lastModified || (new Date()).toString();
                } else if (header.toLowerCase() == 'etag') {
                    return mockHandler.etag || '';
                } else if (header.toLowerCase() == 'content-type') {
                    return mockHandler.contentType || 'text/plain';
                }
            },
            getAllResponseHeaders: function() {
                var headers = '';
                $.each(mockHandler.headers, function(k, v) {
                    headers += k + ': ' + v + "\n";
                });
                return headers;
            }
        };
    }

    // Process a JSONP mock request.
    function processJsonpMock(requestSettings, mockHandler, origSettings) {
        // Handle JSONP Parameter Callbacks, we need to replicate some of the jQuery core here
        // because there isn't an easy hook for the cross domain script tag of jsonp

        processJsonpUrl(requestSettings);

        requestSettings.dataType = "json";
        if (requestSettings.data && CALLBACK_REGEX.test(requestSettings.data) || CALLBACK_REGEX.test(requestSettings.url)) {
            createJsonpCallback(requestSettings, mockHandler, origSettings);

            // We need to make sure
            // that a JSONP style response is executed properly

            var rurl = /^(\w+:)?\/\/([^\/?#]+)/,
                parts = rurl.exec(requestSettings.url),
                remote = parts && (parts[1] && parts[1] !== location.protocol || parts[2] !== location.host);

            requestSettings.dataType = "script";
            if (requestSettings.type.toUpperCase() === "GET" && remote) {
                var newMockReturn = processJsonpRequest(requestSettings, mockHandler, origSettings);

                // Check if we are supposed to return a Deferred back to the mock call, or just
                // signal success
                if (newMockReturn) {
                    return newMockReturn;
                } else {
                    return true;
                }
            }
        }
        return null;
    }

    // Append the required callback parameter to the end of the request URL, for a JSONP request
    function processJsonpUrl(requestSettings) {
        if (requestSettings.type.toUpperCase() === "GET") {
            if (!CALLBACK_REGEX.test(requestSettings.url)) {
                requestSettings.url += (/\?/.test(requestSettings.url) ? "&" : "?") + (requestSettings.jsonp || "callback") + "=?";
            }
        } else if (!requestSettings.data || !CALLBACK_REGEX.test(requestSettings.data)) {
            requestSettings.data = (requestSettings.data ? requestSettings.data + "&" : "") + (requestSettings.jsonp || "callback") + "=?";
        }
    }

    // Process a JSONP request by evaluating the mocked response text
    function processJsonpRequest(requestSettings, mockHandler, origSettings) {
        // Synthesize the mock request for adding a script tag
        var callbackContext = origSettings && origSettings.context || requestSettings,
            newMock = null;


        // If the response handler on the moock is a function, call it
        if (mockHandler.response && $.isFunction(mockHandler.response)) {
            mockHandler.response(origSettings);
        } else {

            // Evaluate the responseText javascript in a global context
            if (typeof mockHandler.responseText === 'object') {
                $.globalEval('(' + JSON.stringify(mockHandler.responseText) + ')');
            } else {
                $.globalEval('(' + mockHandler.responseText + ')');
            }
        }

        // Successful response
        jsonpSuccess(requestSettings, callbackContext, mockHandler);
        jsonpComplete(requestSettings, callbackContext, mockHandler);

        // If we are running under jQuery 1.5+, return a deferred object
        if ($.Deferred) {
            newMock = new $.Deferred();
            if (typeof mockHandler.responseText == "object") {
                newMock.resolveWith(callbackContext, [mockHandler.responseText]);
            } else {
                newMock.resolveWith(callbackContext, [$.parseJSON(mockHandler.responseText)]);
            }
        }
        return newMock;
    }


    // Create the required JSONP callback function for the request
    function createJsonpCallback(requestSettings, mockHandler, origSettings) {
        var callbackContext = origSettings && origSettings.context || requestSettings;
        var jsonp = requestSettings.jsonpCallback || ("jsonp" + jsc++);

        // Replace the =? sequence both in the query string and the data
        if (requestSettings.data) {
            requestSettings.data = (requestSettings.data + "").replace(CALLBACK_REGEX, "=" + jsonp + "$1");
        }

        requestSettings.url = requestSettings.url.replace(CALLBACK_REGEX, "=" + jsonp + "$1");


        // Handle JSONP-style loading
        window[jsonp] = window[jsonp] || function(tmp) {
            data = tmp;
            jsonpSuccess(requestSettings, callbackContext, mockHandler);
            jsonpComplete(requestSettings, callbackContext, mockHandler);
            // Garbage collect
            window[jsonp] = undefined;

            try {
                delete window[jsonp];
            } catch (e) {}

            if (head) {
                head.removeChild(script);
            }
        };
    }

    // The JSONP request was successful
    function jsonpSuccess(requestSettings, callbackContext, mockHandler) {
        // If a local callback was specified, fire it and pass it the data
        if (requestSettings.success) {
            requestSettings.success.call(callbackContext, mockHandler.responseText || "", status, {});
        }

        // Fire the global callback
        if (requestSettings.global) {
            trigger(requestSettings, "ajaxSuccess", [{},
            requestSettings]);
        }
    }

    // The JSONP request was completed
    function jsonpComplete(requestSettings, callbackContext) {
        // Process result
        if (requestSettings.complete) {
            requestSettings.complete.call(callbackContext, {}, status);
        }

        // The request was completed
        if (requestSettings.global) {
            trigger("ajaxComplete", [{},
            requestSettings]);
        }

        // Handle the global AJAX counter
        if (requestSettings.global && !--$.active) {
            $.event.trigger("ajaxStop");
        }
    }


    // The core $.ajax replacement.
    function handleAjax(url, origSettings) {
        var mockRequest, requestSettings, mockHandler;

        // If url is an object, simulate pre-1.5 signature
        if (typeof url === "object") {
            origSettings = url;
            url = undefined;
        } else {
            // work around to support 1.5 signature
            origSettings.url = url;
        }

        // Extend the original settings for the request
        requestSettings = $.extend(true, {}, $.ajaxSettings, origSettings);

        // Iterate over our mock handlers (in registration order) until we find
        // one that is willing to intercept the request
        for (var k = 0; k < mockHandlers.length; k++) {
            if (!mockHandlers[k]) {
                continue;
            }

            mockHandler = getMockForRequest(mockHandlers[k], requestSettings);
            if (!mockHandler) {
                // No valid mock found for this request
                continue;
            }

            mockedAjaxCalls.push(requestSettings);

            // If logging is enabled, log the mock to the console
            $.mockjaxSettings.log(mockHandler, requestSettings);


            if (requestSettings.dataType === "jsonp") {
                if ((mockRequest = processJsonpMock(requestSettings, mockHandler, origSettings))) {
                    // This mock will handle the JSONP request
                    return mockRequest;
                }
            }


            // Removed to fix #54 - keep the mocking data object intact
            //mockHandler.data = requestSettings.data;

            mockHandler.cache = requestSettings.cache;
            mockHandler.timeout = requestSettings.timeout;
            mockHandler.global = requestSettings.global;

            copyUrlParameters(mockHandler, origSettings);

            (function(mockHandler, requestSettings, origSettings, origHandler) {
                mockRequest = _ajax.call($, $.extend(true, {}, origSettings, {
                    // Mock the XHR object
                    xhr: function() {
                        return xhr(mockHandler, requestSettings, origSettings, origHandler);
                    }
                }));
            })(mockHandler, requestSettings, origSettings, mockHandlers[k]);

            return mockRequest;
        }

        // We don't have a mock request
        if ($.mockjaxSettings.throwUnmocked === true) {
            throw ('AJAX not mocked: ' + origSettings.url);
        } else { // trigger a normal request
            return _ajax.apply($, [origSettings]);
        }
    }

    /**
     * Copies URL parameter values if they were captured by a regular expression
     * @param {Object} mockHandler
     * @param {Object} origSettings
     */
    function copyUrlParameters(mockHandler, origSettings) {
        //parameters aren't captured if the URL isn't a RegExp
        if (!(mockHandler.url instanceof RegExp)) {
            return;
        }
        //if no URL params were defined on the handler, don't attempt a capture
        if (!mockHandler.hasOwnProperty('urlParams')) {
            return;
        }
        var captures = mockHandler.url.exec(origSettings.url);
        //the whole RegExp match is always the first value in the capture results
        if (captures.length === 1) {
            return;
        }
        captures.shift();
        //use handler params as keys and capture resuts as values
        var i = 0,
            capturesLength = captures.length,
            paramsLength = mockHandler.urlParams.length,
            //in case the number of params specified is less than actual captures
            maxIterations = Math.min(capturesLength, paramsLength),
            paramValues = {};
        for (i; i < maxIterations; i++) {
            var key = mockHandler.urlParams[i];
            paramValues[key] = captures[i];
        }
        origSettings.urlParams = paramValues;
    }


    // Public

    $.extend({
        ajax: handleAjax
    });

    $.mockjaxSettings = {
        //url:        null,
        //type:       'GET',
        log: function(mockHandler, requestSettings) {
            if (mockHandler.logging === false || (typeof mockHandler.logging === 'undefined' && $.mockjaxSettings.logging === false)) {
                return;
            }
            if (window.console && console.log) {
                var message = 'MOCK ' + requestSettings.type.toUpperCase() + ': ' + requestSettings.url;
                var request = $.extend({}, requestSettings);

                if (typeof console.log === 'function') {
                    console.log(message, request);
                } else {
                    try {
                        console.log(message + ' ' + JSON.stringify(request));
                    } catch (e) {
                        console.log(message);
                    }
                }
            }
        },
        logging: true,
        status: 200,
        statusText: "OK",
        responseTime: 500,
        isTimeout: false,
        throwUnmocked: false,
        contentType: 'text/plain',
        response: '',
        responseText: '',
        responseXML: '',
        proxy: '',
        proxyType: 'GET',

        lastModified: null,
        etag: '',
        headers: {
            etag: 'IJF@H#@923uf8023hFO@I#H#',
            'content-type': 'text/plain'
        }
    };

    $.mockjax = function(settings) {
        var i = mockHandlers.length;
        mockHandlers[i] = settings;
        return i;
    };
    $.mockjaxClear = function(i) {
        if (arguments.length == 1) {
            mockHandlers[i] = null;
        } else {
            mockHandlers = [];
        }
        mockedAjaxCalls = [];
    };
    $.mockjax.handler = function(i) {
        if (arguments.length == 1) {
            return mockHandlers[i];
        }
    };
    $.mockjax.mockedAjaxCalls = function() {
        return mockedAjaxCalls;
    };
})(jQuery);

$.mockjax({ url: "/mockjax", responseTime: 2500 });
	</script>
	
    <style scoped>
        #progressBar {
            width: 390px;
            margin-bottom: 10px;
        }
        .demo-section {
            width: 470px;
            text-align: center;
        }
        .console {
			height: 200px;
            margin: 0;
        }
		
        #left-pane, #center-pane, #right-pane  { 
			background-color: rgba(60, 70, 80, 0.05);
		}
		
		
		.modal {
			display:    none;
			position:   fixed;
			z-index:    1000;
			top:        0;
			left:       0;
			height:     100%;
			width:      100%;
			background: rgba( 255, 255, 255, .8 ) 
            url('http://sampsonresume.com/labs/pIkfp.gif') 
            50% 50% 
            no-repeat;
		}

		body.loading {
			overflow: hidden;   
		}

		body.loading .modal {
			display: block;
		}	
    </style> 

	
			
</body>
</html>
